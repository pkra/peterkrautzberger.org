<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Web components for (mathematical) writing, a first problem</title>
		<link rel="stylesheet" href="/css/index.css">
		<link rel="alternate" href="/atom.xml" type="application/atom+xml" title="Peter Krautzberger">
    <meta name="Description" content="Web components for (mathematical) writing, a first problem">
    <meta name="theme-color" content="#fff">
		<link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon-180x180.png ">
    <link rel="shortcut icon" href="/public/favicon.ico">
    <link rel="manifest" href="/public/manifest.json">
    <script>if ('serviceWorker' in navigator) {  navigator.serviceWorker.register('/serviceworker.js');}</script>
	</head>
	<body>
  <header>
    <div class="masthead">
      <div class="container">
        <div class="masthead-title">
          <a href="/">Peter Krautzberger</a>
          <small> Â· on the web</small>
        </div>
      </div>
    </div>
  </header>

		<main class="container content">
			


<article class="post">
  <h1 class="post-title">Web components for (mathematical) writing, a first problem</h1>
  <span class="post-date"><time datetime="2023-11-14">14 Nov 2023</time></span>
  <p>So a while back - checks notes - <em>ahem</em>, 6 years ago <a href="https://scoskey.org/">Sam</a> gifted me with some of his precious time to do <a href="https://github.com/pkra/laml/">a fun little experiment</a> around writing mathematical long form using the web. With "using the web", I don't mean writing markdown or LaTeX (or whatever) and converting that to HTML. Instead, I had this weird idea that we could actually use the web platform - HTML, CSS, JS - to write content. Sounds crazy, right?</p>
<p>Well, it kind of was. We gave up after a few months (due to life in general but also after getting stuck on paragraphs of all things) and I have been meaning to come back to it ever since.  At the end of October I was finally of a mind to do just that.</p>
<p>Back then I had already wanted to restart this as an experiment in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Components">web components</a>, getting a chance to do more than write a few dummy components.  I'm not very far along but there have already been a few lessons for me. Instead of <a href="/0218">spending</a> <a href="/0220">years</a> on a blog post, I thought I'd try to jot down a first problem I ran into. If only because then I'd document my thoughts a little.</p>
<p>One of the many reasons that Sam was relentelessly helpful back then is that he is a working mathematician (as opposed to myself). So when I think about a possible user experience for writing long form mathematical documents he is the kind of user I'd turn to -  knowledgeable and open to exploring new ideas. Obviously, we both grew up mathematically with LaTeX so that was a base line in terms of UX. You might think LaTeX would not be a high bar but of course muscle memory for any system develops a UX of its own. I mean, you'd think just showing someone <a href="https://docs.emmet.io/">emmet</a> and modern linting&amp;debugging tools would be amazing for people stuck in TeX's Chomsky-Type-1-maybe-0-hell.</p>
<p>Perhaps needless to say but just because we started out from the point of view of a working mathematician doesn't mean that there's not something to be found that benefits a wider audience.</p>
<p>Anyway. Let me focus on my first steps starting fresh. So. The idea is to write some web components that magically solve particular challenges or pain points. Let's collect a few.</p>
<p>A central item for mathematical writing is first-class support for <em>enunciations</em> (as the <a href="https://www.ams.org/arc/styleguide/index.html">AMS style guide</a> lovingly calls them), that is definitions, theorems, propositions, lemmata, remarks etc. - and the ever problematic proof environment.</p>
<p>Another item that makes TeX great is automation around counters. A particular key to magically populating labels of various things - sectioning elements, figures, enunciations, and equations - with (sometimes too much) control for resetting and adjusting them.</p>
<p>Finally, a central item is magic around referencing - just specify the ID and you get a lot of magic to fill those references. Even more so if you use fancier packages like cleverref.</p>
<p>As a first test, those felt like a good set of items: enunciations, automatic labeling and magical cross-references.</p>
<h2>Generating content with web components</h2>
<p>We want our HTML simple. In emmet terms: type <code>thm-&gt;p</code>, then hit <kbd>TAB</kbd>, finally write the first paragraph.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thm-</span><span class="token punctuation">&gt;</span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This is amazing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thm-</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>That's nice. [Fun fact: custom elements need a dash and <code>thm-</code> is valid - though <code>-thm</code> is not.]</p>
<p>But where's our label? Well, we can generate it automatically. Since I know I'll have plenty of variation, I start with a simple base element:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// enunciation base</span><br><span class="token keyword">class</span> <span class="token class-name">enunciation</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token comment">// no boilerplate to keep this short</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'Enunciation'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// this.setAttribute('role', '???'); // let's get to that another time</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><span class="token string">'afterbegin'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;enunciation-label&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/enunciation-label</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'enunciation-'</span><span class="token punctuation">,</span> enunciation<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Long names are ok, I think, since this element is not meant to be used directly; verbosity is not the problem here but hopefully helps with understanding the output. [Or not, let's not tie ourselves down this early.]</p>
<p>When this element is enters the DOM (or more likely: gets upgraded), it will generate a label, containing a customizable name. (Should I use templates and slots? Should I look into mixins? Way too early to answer, I think. Let's stay naive as long as we can.)</p>
<p>Anyway, the key thing is that we can pass an argument to <code>connectedCallback</code> which we do in our actual theorem element:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// theorem</span><br><span class="token keyword">class</span> <span class="token class-name">theorem</span> <span class="token keyword">extends</span> <span class="token class-name">enunciation</span> <span class="token punctuation">{</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token string">'Theorem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'thm-'</span><span class="token punctuation">,</span> theorem<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Fair enough, we have generated our label - and a prototype to base other enunciations on. Let's move on.</p>
<h2>CSS counters are sooo lovely (until they aren't)</h2>
<p>For automatic counters, CSS goes very well with our components.</p>
<p>Just add</p>
<pre class="language-css"><code class="language-css"><span class="token selector">thm-</span> <span class="token punctuation">{</span><br>  <span class="token property">counter-increment</span><span class="token punctuation">:</span> thmCounter<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token selector">thm- &gt; enunciation-label::after</span> <span class="token punctuation">{</span><br>  <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">" "</span> <span class="token function">counter</span><span class="token punctuation">(</span>thmCounter<span class="token punctuation">)</span> <span class="token string">". "</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Sweet. This seems super simple.</p>
<p>Resetting CSS counters is also trivial; typical variations in mathematical writing such as adding a title alongside the label or an option to surpress the label would be straight forward next steps.</p>
<p>However, let's ignore these tempting side quests and move on again so we can run into trouble.</p>
<h3>Call me by my label</h3>
<p>At first, the third item seem equally easy: magic cross references with web components.</p>
<p>Obviously, we need a point of reference and a reference to it. Let's adjust our theorem example; in emmet terms: <code>thm#thm&gt;p</code>. Also, add a paragraph with a cross-reference to that ID, maybe (in emmet) <code>ref[target=thm]</code>.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thm-</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>thm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This is amazing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thm-</span><span class="token punctuation">&gt;</span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Have you heard about <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref-</span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>thm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ref-</span><span class="token punctuation">&gt;</span></span>?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>Could be that <code>target</code> is too long but I like readable strings. In any case: what should <code>ref-</code> do? Well, just find the label of the theorem and use that, obvs.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">crossreference</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> targetId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>targetId<span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'enunciation-label'</span><span class="token punctuation">)</span><span class="token operator">?.</span>innerHTML <span class="token operator">||</span> targetId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/a&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// maybe prepend so authors can add parenthetical notes?</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'ref-'</span><span class="token punctuation">,</span> crossreference<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Finally, I run into trouble. The resulting link just says "Theorem", not "Theorem 1". That's not super helpful (and clearly fails <a href="https://www.w3.org/WAI/WCAG22/quickref/?versions=2.1#link-purpose-in-context">WCAG 2.4.4</a>). But of course that's my mistake - the <code>innerHTML</code> is "Theorem", after all.</p>
<p>So how do you get the pseudo-element's content? As you might do, I hit the usual search engines to figure out if it can be done. In the process, I found some ancient stackoverflow posts - but it's not too helpful to know this didn't work in 2008.</p>
<p>I eventually remembered that getComputedStyle can look up pseudo elements. But unfortunately it gives us <code>" " counter(thmCounter) ". "</code>- very much correct and very much not what I want. (Reminds me of an old joke about mathematicians, fog and a hot air balloon, actually.)</p>
<p>So <a href="https://bonn.social/@pkra/111314587141501059">I asked my fedi bubble</a> and kind people helped - only to confirm that it's <a href="https://github.com/w3c/csswg-drafts/issues/5879">not doable today</a>, despite having been <a href="https://discourse.wicg.io/t/query-live-counter-values-via-cssom/415/13">discussed by relevant people (approvingly) 9 years ago</a>.</p>
<p>Shucks.</p>
<h3>This is why we can't have nice things</h3>
<p>I guess we'll have to realize the wonders of CSS counters in our custom elements instead. Hold my beer?</p>
<p>Ok, maybe just a counter for what we need? Either way, then we can populate the label with the actual counter directly, and references will start to work. A quick &amp; dirty solution might be something like this</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">enunciation</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'Enunciation'</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><span class="token string">'afterbegin'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;enunciation-label&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>counter <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>counter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/enunciation-label</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">theorem</span> <span class="token keyword">extends</span> <span class="token class-name">enunciation</span> <span class="token punctuation">{</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token operator">++</span>theorem<span class="token punctuation">.</span>counter<span class="token punctuation">;</span><br>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token string">'Theorem'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br>theorem<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre>
<p>Well, that feels quick and dirty. But it also raises some questions.</p>
<p>As I already mentioned, CSS counters offer a lovely resetting mechanism - just something like</p>
<pre class="language-css"><code class="language-css"><span class="token selector">section</span> <span class="token punctuation">{</span><br>    <span class="token property">counter-reset</span><span class="token punctuation">:</span> thmCounter<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>to reset the theorem counter at the start of each section. I need something for that as well.</p>
<p>I guess if I have a custom sectioning element, say <code>chapter-</code>, I could try resetting this:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">chapter</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'role'</span><span class="token punctuation">,</span> <span class="token string">'doc-chapter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    theorem<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// (don't do this)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Even if I make that work, what would I do for a regular HTML sectioning element like <code>article</code> or <code>section</code>? Well, I can't. Instead, I'll have to exclusively use custom elements for sectioning (<code>sec-</code> maybe?), so I can do this kind of a reset. [Though maybe that's not a real problem since I probably want <code>ref-</code>s pointing to sections.]</p>
<p>It was funny how dirty this reset felt to me. I mean, it is how CSS does it, right? Then again, perhaps <code>counter-reset</code> is an excellent footgun on the CSS end? I admit I've never used it outside of lists.</p>
<p>Anyway.</p>
<p>To keep the counter logic in the theorem element, I need to find out how many theorems precede the current one. Maybe a quick&amp;dirty while-loop along <code>previousElementSibling</code> is enough - if you're a super clean author and theorems with related counter values are surely siblings, good for you, I'm probably not. I could also go full on DOM treewalker to walk up the DOM to find the previous theorem, read its counter, increment it (with some break condition to match the counter reset desires).</p>
<p>As with everything I've written here, I have no answer, but at least a few ideas. For now I'm taking what feels like the middle ground - find a closest ancestor of my (reset-)liking, look at the reset's descendants, use the current element's index therein.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> siblings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span><span class="token string">'section'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token string">'Theorem'</span><span class="token punctuation">,</span> siblings<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The end result seems good enough for now; easy to muck about, learn, try something.</p>
<p class="codepen" data-height="300" data-default-tab="html,result" data-slug-hash="rNPeBKR" data-preview="true" data-user="pkra" style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/pkra/pen/rNPeBKR">
  Theorems with counters, part 1</a> by Peter Krautzberger (<a href="https://codepen.io/pkra">@pkra</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>
<p>The code is so trivial that I can throw it away once I've learned more (e.g., how about "Theorem 2.1"? should that label be inside the first paragraph? What role to use?).</p>
<p>As an aside, the links earlier point to <a href="https://drafts.csswg.org/css-content/#target-counter">target-counter</a> from the CSS Generated Content Level 3 spec where you'll also find target-text. Besides not having gained any traction I admit I find those three oddly unappealing. It seems more natural to me to have "getComputedText" to access the actual pseudo-element value, e.g., when <code>attr()</code> is involved. But perhaps I'm too JS-oriented here; it just seems to me like people would need this anyway to cover more ground. And maybe it's lower hanging fruit.</p>
<p>In any case, surely there's more trouble ahead. On the bright side, I know this will continue to work for a very (very) long time thanks to the backward compatibility of the web platform. (Definitely longer than the LaTeX stylesheets from my PhD thesis.) And once counters catch up, I can simplify.</p>
<p>In the end, this first set of experiments has worked out as I'd hoped. It got me thinking (and learning) about web components again, about limitations of the web platform, and about writing itself. More than I expected to get to in a few evenings.</p>
<p>In the mean time, I've continued this journey a bit further. But that's another story for another time perhaps.</p>

</article>

<aside class="related">
  <span> To leave a comment <a href="mailto:p.krautzberger@gmail.com?subject=Comment%20re%20Web%20components%20for%20(mathematical)%20writing%2C%20a%20first%20problem">write me an email</a>.
  </span>
  <span> You can also <a href="/contact/">contact me</a>.</span>
</aside>




		</main>

  <footer class="container related">
    Â© 2022 <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">cc-by</a> (unless noted otherwise).
    For more, subscribe to the <a href="/atom.xml">RSS/Atom feed</a>, visit the <a href="/archive/">archive</a> or the <a href="/about/">about</a> page.
  </footer>

		<!-- Current page: /0220/ -->
	</body>
</html>
